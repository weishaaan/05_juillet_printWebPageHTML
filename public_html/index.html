<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Printer page</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css">
        <script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>
        <script src="https:/maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.10.1/bootstrap-table.min.css">
        <script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.10.1/bootstrap-table.min.js"></script>
        <link rel="shortcut icon" href="">
        <script src="//oss.maxcdn.com/bootbox/4.2.0/bootbox.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-validator/0.5.3/js/bootstrapValidator.js"></script>
        
        <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
        
        <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
    
    </head>

    <body>
        <div><div class="well">MORA - Printing Service</div></div>
        <p></p>
        <p><b>         Motus étiquettes de cartons</b></p>
        <p></p>
        <div class="container"> 
            <div class="row">
                <div class="col-xs-6 col-md-4"><div class="well">
                        <table id="eventsTable" data-height="160">
                            <thead>
                                <tr>
                                    <th data-field="state" data-radio="true"></th>
                                    <th data-field="ofNum">ofNum</th>
                                    <!--
                                    
                                    <th data-field="sreference">sreference</th>
                                    -->
                                </tr>
                            </thead>
                        </table>
                    </div></div>

                <div class="col-xs-6 col-md-4"><div class="well">
                        <label>Info détaillé:</label>
                        <p></p>
                        <label for="ofNum">ofNum:</label>
                        <label id="ofNum"></label>
                        <p></p>
                        <label for="ref">Ref: </label>
                        <label id="ref"></label>
                        <p></p>
                        <label for="ref">sReference: </label>
                        <label id="sref"></label>
                        <p></p>
                    </div></div>

                <div class="col-xs-6 col-md-4"><div class="well">
                        <p></p>
                        <table id="printerTable" data-height="160">
                            <thead>
                                <tr>
                                    <th data-field="state" data-radio="true"></th>
                                    <th data-field="NAME">Imprimantes</th>
                                </tr>
                            </thead>
                        </table>
                    </div></div>

                <div style="display: none;">
                    <label id="printer_name"></label>
                </div>

                <div class="col-xs-6 col-md-4">
                    <div class="well">
                        <p><b>Étiquettes</b></p>
                        <p></p>
                        <!--<form role="form" id="etiquette_form"></form>-->
                            <div class="form-group">
                                <label for="number">Nombre:</label>
                                <input type="text" class="form-control" id="number">
                            </div>
                            <div class="form-group">
                                <label for="labelTypeCombo">Étiquette Type:</label>
                                <select name="labelTypeCombo_select" class="selectpicker" id="labelTypeCombo">
                                     <option value="" >Choisir un type</option>
                                    
                                </select>
                        </div>
                    </div>
                </div>
       
                <div class="form-group" id="model" style="display: none;">
                    <label for="xman"></label>
                    <input type="text" id="xman" />
                </div>

                <div class="col-xs-6 col-md-4">
                    <div class="well">
                        <p><b>Champs à compléter</b></p>
                        <p ></p>
                        <div id="userInput"></div>  

                    </div>
                </div>
                <div class="col-xs-6 col-md-4">
                    <div >
                        <button id="btn_print" >Imprimer</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            $(document).ready(function () {
                
                var request = new XMLHttpRequest();
                request.open("GET", "config.xml", false);
                request.send();
                var xml = request.responseXML;
                var config = xml.getElementsByTagName("configuration");
                
                for(var i = 0; i < config.length; i++) {
                    var url = config[i];
                    var names = url.getElementsByTagName("url");
                    var url_OfList = names[0].childNodes[0].nodeValue;
                    var url_allPrinters = names[1].childNodes[0].nodeValue;
                    var url_post = names[2].childNodes[0].nodeValue;
                    var url_labelType = names[3].childNodes[0].nodeValue;
                    //for(var j = 0; j < names.length; j++) {
                      //  alert(names[j].childNodes[0].nodeValue);
                    //}
                }
                //alert("url_allPrinters  :" +url_allPrinters);
                /*$( "#datepicker" ).datepicker({
                    changeMonth: true,//this option for allowing user to select month
                    changeYear: true, //this option for allowing user to select from year range
                    monthNames: ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'],
                    monthNamesShort: ['Janv.', 'Févr.', 'Mars', 'Avril', 'Mai', 'Juin', 'Juil.', 'Août', 'Sept.', 'Oct.', 'Nov.', 'Déc.'],
                    dayNames: ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'],
                    dayNamesShort: ['Dim.', 'Lun.', 'Mar.', 'Mer.', 'Jeu.', 'Ven.', 'Sam.'],
                    dayNamesMin: ['D', 'L', 'M', 'M', 'J', 'V', 'S'],
                    weekHeader: 'Sem.',
                    dateFormat: 'dd-mm-yy',
                    onSelect: function(dateText, inst) {
                        date = dateText;
                    }

                });*/
            //eventsTable    
                $.ajax({
                    type: "GET",
                    url: url_OfList, //"http://localhost:8080/PrintMvnWeb/webresources/home/getOfList",
                    dataType: "json",
                    success: function (data) {
                        //alert("Success!\n" + "data is:" + JSON.stringify(data));
                        $('#eventsTable').bootstrapTable({data: data});
                        $("#eventsTable tbody tr td input").each(function(i) {
                            $(this).attr('name', 'ofNum');
                        });
                    },
                    error: function (data) {
                        alert('Error: ' + data);
                    }
                });
                
                $('#eventsTable').on('check.bs.table', function (e, row) {
                    console.log([{ofNum: row.ofNum, reference: row.reference, sreference: row.sreference}]);
                    $('#ofNum').text(row.ofNum);
                    $('#ref').text(row.reference);
                    $('#sref').text(row.sreference);
                });
                
                var printerData;
                
            //printerTable    
                $.ajax({
                    type: "GET",
                    url: url_allPrinters, //"http://localhost:8080/PrintMvnWeb/webresources/home/getAllPrinter
                    dataType: "json",
                    success: function (data) {
                        //alert("Success!\n" + "data is:" + JSON.stringify(data));
                        $('#printerTable').bootstrapTable({data: data});
                        
                        printerData = JSON.stringify(data);
                        $("#printerTable tbody tr td input").each(function(i) {
                          //  $(this).attr('name', 'NAME');
                        });
                    },
                    error: function (data) {
                        alert('Error: ' + data);
                    }
                });
/*
                $('#printerTable tbody tr').each(function(){
                    $(this).attr('name','printer');
                });*/
               
                $('#printerTable').on('check.bs.table', function (e, row) {
                    console.log("printer NAME is :"+ row.NAME);
                    $('#printer_name').text(row.NAME);
                });
                
                
            //labelTypeCombo   
                
                var comboData;
                var fields='';
                var postFields;
                var inputCodeArray=[];
                $.ajax({
                    type: "GET",
                    url: url_labelType, // "http://localhost:8080/PrintMvnWeb/webresources/home/getLabelTypes",
                    dataType: "json",
                    success: function (data) {
                        comboData = data;
                        //alert("Success!\n" + "data is:" + JSON.stringify(data));
                        $.each(data,function(index){
                            //alert("label toString is :" + data[index].labelName);
                            $('#labelTypeCombo').append("<option value= " + data[index].reference + ">" + data[index].labelName + "</option>")
                            
                        });
                    },
                    error: function (data) {
                        alert('Error: ' + data);
                    }
                });
            
            
               
            $("#labelTypeCombo").change(function() {   // 2
                //alert("this.value : "+this.value);  //this.value = reference
                var value = this.value;
                
                $.each(comboData,function(index){
                    //alert("comboData[index].reference : "+ comboData[index].reference); 
                    inputCodeArray.length = 0;
                    if(comboData[index].reference === value){
                        //alert("equal!");
                        fields = '';
                        $.each(comboData[index].listField,function(i){               
                            if(comboData[index].listField[i].SOURCE === 'UserInput' ){
                                //alert('source is '+comboData[index].listField[i].SOURCE);
                                fields = fields + '<label for="'+  comboData[index].listField[i].CODE  + '">'+
                                        comboData[index].listField[i].DESCRIPTION +':   </label><input type="text" id="' + 
                                        comboData[index].listField[i].CODE+'" /><p></p>';
                                inputCodeArray.push(comboData[index].listField[i].CODE);
                            }
                        });
                        if(fields !== ''){
                            fields = ' <div class="form-group" id="'+ comboData[index].reference +'" >' + fields +'</div>';
                            $("#userInput").html(fields);
                            //alert( "inputCodeArray.length : "+inputCodeArray.length );
                            return false;
                        }else{
                            fields = ' <div class="form-group" id="'+ comboData[index].reference +'" >' + 'no need to input for this label'+'</div>';
                            $("#userInput").html(fields);
                            //alert( "inputCodeArray.length : "+inputCodeArray.length );
                            return false;
                        }
                    }
                });
            });    
            
            //post button 
            $("#btn_print").click(function () {
                var postMessage;
                var ss = '';
                var result = null;
                var ofNum_val;
                var ip_val;
                var NAME_val;
                var num_val;
                var type_val;
                
                var postInputArray = [];
                
                NAME_val = $('#printer_name').text();
                ofNum_val = $('#ofNum').text();
                num_val = $.trim($('#number').val());
                type_val = $('select[name=labelTypeCombo_select] option:selected').val();
               
                if (ofNum_val === '')
                    ss = ss + "l'Of \n";
                if (NAME_val === '')
                    ss = ss + "l'imprimante \n";
                if (num_val === '')
                    ss = ss + "le nombre de Etiquettes \n";
                if (type_val === '')
                    ss = ss + "le type de Etiquettes \n";
                if (inputCodeArray.length !== 0){
                    var i;
                    for (i = 0; i < inputCodeArray.length; ++i) {
                        //alert("input val is :" + $('#' + inputCodeArray[i]).val());
                        if($('#' + inputCodeArray[i]).val() === '' || $('#' + inputCodeArray[i]).val() === null)
                            ss = ss + "le valeur de "+ inputCodeArray[i] + "\n";
                    }
                }
                
                if (ss !== '') {
                    result = "Vous avez besoin de saisir/choisir ces valeurs dans les champs correspondants: \n" + ss;
                    alert(result);
                } else {
                    
                    if (inputCodeArray.length !== 0){
                        var i;
                        
                        for (i = 0; i < inputCodeArray.length; i++) {
                            var inputArray = new Object();
                            inputArray.code = inputCodeArray[i];
                            inputArray.value = $('#' + inputCodeArray[i]).val();
                            //alert("JSON.stringify(inputArray) : "+JSON.stringify(inputArray));
                            //postInputArray.push(JSON.stringify(inputArray));
                            postInputArray.push(inputArray);
                        }    
                    }
                    //alert("postInputArray nknknknk.: "+JSON.stringify(postInputArray));
                    
                    
                    printerData = $.parseJSON(printerData);
                    $.each(printerData, function(index) {
                        ip_val = printerData[index].IP;
                        if(printerData[index].NAME === NAME_val){
                            //alert("ip_val is:"+ ip_val+",NAME in the json data is :" + printerData[index].NAME  + ", name_val is "+ NAME_val);
                            return false;
                        }
                    }); 
                    postMessage = {ofNum: ofNum_val, ip: ip_val, num: num_val, type: type_val, userInputs: postInputArray};

                    alert("Now launcing web service!");
                    alert(JSON.stringify(postMessage));
                    $.ajax({
                        url: url_post,//"http://localhost:8080/PrintMvnWeb/webresources/home/postPrintMessage",
                        type: 'POST',
                        dataType: 'text',
                        data: JSON.stringify(postMessage),
                        headers: {
                            'Accept': 'text/plain',
                            'Content-Type': 'application/json'
                        },
                        success: function (result) {
                            alert("success post to web service! result is " + JSON.stringify(result));
                            window.location.href = "retour.html";
                        },
                        error: function (result) {
                            alert("wrong: " + JSON.stringify(result));
                        }
                    });
                }
            });
    });


        </script>

    </body>
</html>